services:
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    restart: unless-stopped
    environment:
      - POSTGRES_DB=finance
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - TZ=${TZ}
    volumes:
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - timescaledb_data:/var/lib/postgresql/data
    networks:
      - finance-net

  gordon-worker:
    build:
      context: ./GordonWorker
      dockerfile: Dockerfile
    restart: unless-stopped
    user: root
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - ConnectionStrings__DefaultConnection=Host=timescaledb;Database=finance;Username=postgres;Password=${DB_PASSWORD}
      - INVESTEC_CLIENT_ID=${INVESTEC_CLIENT_ID}
      - INVESTEC_SECRET=${INVESTEC_SECRET}
      - INVESTEC_API_KEY=${INVESTEC_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=${JWT_ISSUER:-GordonFinanceEngine}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-GordonUsers}
      - TZ=${TZ}
    volumes:
      - gordon_keys:/app/keys
    networks:
      - finance-net
    depends_on:
      - timescaledb
    ports:
      - "52944:8080"

networks:
  finance-net:


volumes:
  timescaledb_data:
  gordon_keys:
