<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gordon Finance Engine</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js?v=3.5"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden flex flex-col">

    <div id="app" v-cloak class="flex-1 flex flex-col h-full overflow-hidden relative">

        <!-- AUTH OVERLAY -->
        <div v-if="!auth.token" class="fixed inset-0 z-[100] bg-brand-900 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="bg-brand-600 p-8 text-center text-white">
                    <div
                        class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                        <span class="text-3xl font-bold">G</span>
                    </div>
                    <h2 class="text-2xl font-bold">Gordon Finance</h2>
                    <p class="text-white/70 text-sm mt-1">Actuarial spending insights.</p>
                </div>
                <div class="p-8">
                    <div v-if="authView === 'login'" class="space-y-4">
                        <h3 class="text-lg font-bold text-slate-800">Sign In</h3>
                        <input v-model="loginForm.username" type="text" placeholder="Username"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                        <input v-model="loginForm.password" type="password" placeholder="Password" @keyup.enter="login"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                        <button @click="login" :disabled="loading"
                            class="w-full bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-brand-700">
                            {{ loading ? '...' : 'Sign In' }}
                        </button>
                        <p class="text-center text-xs text-slate-500 mt-4 cursor-pointer hover:underline"
                            @click="authView = 'register'">Create an account</p>
                    </div>
                    <div v-else class="space-y-4">
                        <h3 class="text-lg font-bold text-slate-800">Register</h3>
                        <input v-model="registerForm.username" type="text" placeholder="Choose Username"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                        <input v-model="registerForm.password" type="password" placeholder="Choose Password"
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
                        <button @click="register" :disabled="loading"
                            class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-900">
                            {{ loading ? '...' : 'Register' }}
                        </button>
                        <p class="text-center text-xs text-slate-500 mt-4 cursor-pointer hover:underline"
                            @click="authView = 'login'">Back to Login</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- HELP TOOLTIP COMPONENT -->
        <script type="text/x-template" id="help-tooltip-template">
            <div class="relative inline-block ml-1 group">
                <span class="cursor-help text-slate-400 hover:text-brand-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </span>
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg z-50 pointer-events-none text-center">
                    {{ text }}
                    <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
                </div>
            </div>
        </script>

        <!-- MAIN APP -->
        <template v-if="auth.token">
            <header
                class="bg-white border-b border-slate-200 h-16 shrink-0 flex items-center justify-between px-4 lg:px-8 z-20 shadow-sm relative">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <span class="text-xl font-bold">G</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900 leading-tight">Gordon</h1>
                        <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">{{ auth.username }}
                            <span v-if="auth.role === 'Admin'"
                                class="bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-full ml-1">ADMIN</span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex items-center gap-1.5 bg-green-50 px-2.5 py-1 rounded-full border border-green-100 shadow-sm"
                        title="Security Hardened (v2.5.7+)">
                        <svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zM10 5.234A9.969 9.969 0 0115.833 7.7a9.97 9.97 0 011.001 6.3 9.97 9.97 0 01-6.834 5.766A9.97 9.97 0 013.166 14a9.97 9.97 0 011.001-6.3A9.969 9.969 0 0110 5.234zM10 11.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"
                                clip-rule="evenodd" />
                        </svg>
                        <span class="text-[10px] font-bold text-green-700 uppercase tracking-tight">Secure Mode</span>
                    </div>
                    <button @click="logout"
                        class="text-xs font-bold text-slate-400 hover:text-red-500 transition-colors">LOGOUT</button>
                    <div class="md:hidden text-2xl" @click="isMobileMenuOpen = !isMobileMenuOpen">‚ò∞</div>
                </div>
            </header>

            <div class="flex-1 flex overflow-hidden max-w-7xl mx-auto w-full">
                <!-- SIDEBAR -->
                <aside class="hidden md:flex w-64 flex-col border-r border-slate-200 bg-white">
                    <nav class="flex-1 p-4 space-y-1">
                        <button v-for="item in menuItems" :key="item.id" @click="activeTab = item.id"
                            v-show="!item.adminOnly || auth.role === 'Admin'"
                            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all"
                            :class="activeTab === item.id ? 'bg-brand-50 text-brand-700' : 'text-slate-600 hover:bg-slate-50'">
                            <span>{{ item.icon }}</span> {{ item.name }}
                        </button>
                        <button @click="activeTab = 's-rawdata'"
                            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all"
                            :class="activeTab === 's-rawdata' ? 'bg-brand-50 text-brand-700' : 'text-slate-600 hover:bg-slate-50'">
                            <span>raw</span> Raw Data
                        </button>
                    </nav>
                    <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                        <button @click="sendReportNow" :disabled="sendingReport"
                            class="w-full flex items-center justify-center gap-2 py-2.5 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-700 hover:border-brand-300 hover:text-brand-600 shadow-sm transition-all active:scale-95">
                            <span v-if="sendingReport" class="animate-spin">‚è≥</span>
                            <span v-else>üìä</span>
                            {{ sendingReport ? 'Processing...' : 'Run Report' }}
                        </button>
                    </div>
                </aside>

                <!-- CONTENT -->
                <main class="flex-1 overflow-y-auto p-4 lg:p-8 pb-24 md:pb-8 bg-slate-50">

                    <!-- DASHBOARD -->
                    <div v-if="activeTab === 'dashboard'" class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Dashboard</h2>
                            <div class="flex gap-2">
                                <button @click="categorizeExisting" :disabled="categorizing"
                                    class="text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-50 disabled:opacity-50">
                                    {{ categorizing ? '‚è≥ Processing...' : 'üß† Categorize' }}
                                </button>
                                <button @click="forceRepull"
                                    class="text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-50">üîÑ
                                    Sync</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <!-- Investec -->
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Investec API
                                </p>
                                <div class="mt-1 flex items-center justify-between">
                                    <span class="text-lg font-bold"
                                        :class="systemStatus.investecOnline ? 'text-green-600' : 'text-red-600'">
                                        {{ systemStatus.investecOnline ? 'Online' : 'Offline' }}
                                    </span>
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-lg"
                                        :class="systemStatus.investecOnline ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'">
                                        üè¶</div>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">Last seen: {{
                                    formatTime(systemStatus.lastInvestecCheck) }}</p>
                            </div>

                            <!-- Database -->
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Database</p>
                                <div class="mt-1 flex items-center justify-between">
                                    <span class="text-lg font-bold"
                                        :class="systemStatus.databaseOnline ? 'text-green-600' : 'text-red-600'">
                                        {{ systemStatus.databaseOnline ? 'Active' : 'Down' }}
                                    </span>
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-lg"
                                        :class="systemStatus.databaseOnline ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'">
                                        üíæ</div>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">TimescaleDB Hypertable</p>
                            </div>

                            <!-- AI Primary -->
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative group">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Primary AI</p>
                                <div class="mt-1 flex items-center justify-between">
                                    <span class="text-lg font-bold"
                                        :class="systemStatus.aiPrimaryOnline ? 'text-green-600' : (systemStatus.aiPrimaryError?.includes('Rate Limited') ? 'text-amber-500' : 'text-red-600')">
                                        {{ systemStatus.aiPrimaryOnline ? 'Ready' :
                                        (systemStatus.aiPrimaryError?.includes('Rate Limited') ? 'Throttled' :
                                        'Offline') }}
                                    </span>
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-lg"
                                        :class="systemStatus.aiPrimaryOnline ? 'bg-green-50 text-green-600' : (systemStatus.aiPrimaryError?.includes('Rate Limited') ? 'bg-amber-50 text-amber-500' : 'bg-red-50 text-red-600')">
                                        üß†</div>
                                </div>
                                <p v-if="!systemStatus.aiPrimaryOnline && systemStatus.aiPrimaryError"
                                    class="text-[9px] text-red-400 mt-1 italic truncate"
                                    :title="systemStatus.aiPrimaryError">{{ systemStatus.aiPrimaryError }}</p>
                                <p v-else class="text-[10px] text-slate-400 mt-1 truncate">{{ settings.ollamaModelName
                                    }}</p>
                            </div>

                            <!-- AI Fallback -->
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative group">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Backup AI</p>
                                <div class="mt-1 flex items-center justify-between">
                                    <span class="text-lg font-bold"
                                        :class="systemStatus.aiFallbackOnline ? 'text-green-600' : (systemStatus.aiFallbackError?.includes('Rate Limited') ? 'text-amber-500' : 'text-amber-600')">
                                        {{ settings.enableAiFallback ? (systemStatus.aiFallbackOnline ? 'Standby' :
                                        (systemStatus.aiFallbackError?.includes('Rate Limited') ? 'Throttled' :
                                        'Offline')) : 'Disabled' }}
                                    </span>
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-lg"
                                        :class="systemStatus.aiFallbackOnline ? 'bg-green-50 text-green-600' : (systemStatus.aiFallbackError?.includes('Rate Limited') ? 'bg-amber-50 text-amber-500' : 'bg-amber-50 text-amber-600')">
                                        üõ°Ô∏è</div>
                                </div>
                                <p v-if="settings.enableAiFallback && !systemStatus.aiFallbackOnline && systemStatus.aiFallbackError"
                                    class="text-[9px] text-amber-500 mt-1 italic truncate"
                                    :title="systemStatus.aiFallbackError">{{ systemStatus.aiFallbackError }}</p>
                                <p v-else class="text-[10px] text-slate-400 mt-1 truncate">{{
                                    settings.fallbackOllamaModelName || 'Gemini' }}</p>
                            </div>

                            <!-- YoY Seasonality -->
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">YoY Seasonality
                                </p>
                                <div v-if="healthStats && healthStats.SpendSameMonthLastYear > 0"
                                    class="mt-1 flex items-center justify-between">
                                    <span class="text-lg font-bold"
                                        :class="healthStats.YoYChangePercentage > 5 ? 'text-red-600' : (healthStats.YoYChangePercentage < -5 ? 'text-green-600' : 'text-slate-600')">
                                        {{ healthStats.YoYChangePercentage > 0 ? '+' : '' }}{{
                                        healthStats.YoYChangePercentage }}%
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-lg flex items-center justify-center text-lg bg-indigo-50 text-indigo-600">
                                        üóìÔ∏è</div>
                                </div>
                                <div v-else class="mt-1 flex items-center justify-between">
                                    <span class="text-lg font-bold text-slate-300 italic">No Data</span>
                                    <div
                                        class="w-8 h-8 rounded-lg flex items-center justify-center text-lg bg-slate-50 text-slate-300">
                                        üóìÔ∏è</div>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">Vs. Same Month 2025</p>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-800 text-sm">Spending by Category</h3>
                                    <select class="text-[10px] bg-slate-50 border border-slate-200 rounded px-1 py-0.5">
                                        <option>Last 30 Days</option>
                                    </select>
                                </div>
                                <div class="h-64">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-800 text-sm">Balance History</h3>
                                    <button @click="loadCharts"
                                        class="text-[10px] font-bold text-brand-600">REFRESH</button>
                                </div>
                                <div class="h-64">
                                    <canvas id="balanceChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- FINANCIAL HEALTH & RUNWAY PANEL -->
                        <div v-if="healthStats"
                            class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                            <div
                                class="px-6 py-4 border-b border-slate-50 bg-gradient-to-r from-brand-50 to-indigo-50 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-slate-800 text-sm">Financial Health &amp; Runway</h3>
                                    <p class="text-[10px] text-slate-400 mt-0.5">Salary-cycle actuarial analysis</p>
                                </div>
                                <div
                                    class="flex items-center gap-2 bg-white/70 backdrop-blur-sm px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
                                    <span class="text-[10px] font-bold uppercase tracking-wider"
                                        :class="parseFloat(healthStats.ProbabilityToReachPayday) >= 80 ? 'text-green-600' : (parseFloat(healthStats.ProbabilityToReachPayday) >= 50 ? 'text-amber-600' : 'text-red-600')">
                                        {{ healthStats.ProbabilityToReachPayday }}
                                    </span>
                                    <span class="text-[10px] text-slate-400 font-medium">survival prob.</span>
                                </div>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                    <!-- Projected Payday Balance -->
                                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                                            Projected Payday Balance</p>
                                        <p class="text-xl font-bold mt-1"
                                            :class="parseFloat(healthStats.ProjectedBalanceAtPayday) >= 0 ? 'text-green-600' : 'text-red-600'">
                                            {{ formatCurrency(parseFloat(healthStats.ProjectedBalanceAtPayday)) }}
                                        </p>
                                        <p class="text-[10px] text-slate-400 mt-1">In {{ healthStats.DaysUntilNextSalary
                                            }} days</p>
                                    </div>
                                    <!-- Runway -->
                                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                                            Projected Runway</p>
                                        <p class="text-xl font-bold mt-1"
                                            :class="parseFloat(healthStats.RunwayDays) >= healthStats.DaysUntilNextSalary ? 'text-green-600' : 'text-red-600'">
                                            {{ healthStats.RunwayDays }} <span class="text-sm font-medium">days</span>
                                        </p>
                                        <p class="text-[10px] text-slate-400 mt-1">Expected at current burn</p>
                                    </div>
                                    <!-- Spend This Period -->
                                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Spend
                                            This Period</p>
                                        <p class="text-xl font-bold mt-1 text-slate-800">{{
                                            formatCurrency(parseFloat(healthStats.SpendThisPeriod)) }}</p>
                                        <p class="text-[10px] mt-1"
                                            :class="parseFloat(healthStats.SpendThisPeriod) > parseFloat(healthStats.SpendLastPeriod) ? 'text-red-500' : 'text-green-500'">
                                            vs {{ formatCurrency(parseFloat(healthStats.SpendLastPeriod)) }} last period
                                        </p>
                                    </div>
                                    <!-- Upcoming Payments Total -->
                                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                                            Upcoming Committed</p>
                                        <p class="text-xl font-bold mt-1 text-amber-600">{{
                                            formatCurrency(parseFloat(healthStats.UpcomingExpectedPaymentsTotal)) }}</p>
                                        <p class="text-[10px] text-slate-400 mt-1">{{
                                            healthStats.UpcomingFixedCosts?.length || 0 }} fixed costs pending</p>
                                    </div>
                                </div>

                                <!-- Upcoming Fixed Costs List -->
                                <div v-if="healthStats.UpcomingFixedCosts && healthStats.UpcomingFixedCosts.length > 0">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">
                                        Upcoming Fixed Costs This Cycle</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        <div v-for="cost in healthStats.UpcomingFixedCosts" :key="cost.Name"
                                            class="flex items-center justify-between bg-amber-50 border border-amber-100 rounded-lg px-4 py-2.5">
                                            <div class="flex items-center gap-2">
                                                <span class="text-amber-500 text-xs">üìÖ</span>
                                                <span class="text-xs font-semibold text-slate-700 truncate max-w-28">{{
                                                    cost.Name }}</span>
                                            </div>
                                            <span class="text-xs font-bold text-amber-700 ml-2 shrink-0">{{
                                                formatCurrency(parseFloat(cost.Amount)) }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="text-center py-3 text-[10px] text-green-600 font-bold">
                                    ‚úÖ All expected fixed costs have been paid this cycle
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                <p class="text-xs font-medium text-slate-400 uppercase">Telegram Hits</p>
                                <div class="mt-1">
                                    <span class="text-lg font-bold text-slate-900">{{
                                        formatTime(systemStatus.lastTelegramHit) }}</span>
                                    <span v-if="systemStatus.lastTelegramError"
                                        class="block text-[10px] text-red-500 font-bold mt-1 truncate"
                                        :title="systemStatus.lastTelegramError">‚ö† {{ systemStatus.lastTelegramError
                                        }}</span>
                                    <span v-else-if="systemStatus.lastTelegramHit"
                                        class="block text-[10px] text-green-500 font-bold mt-1">‚úî Active</span>
                                </div>
                            </div>
                            <div
                                class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-medium text-slate-400 uppercase tracking-wider">Last Health
                                        Sync</p>
                                    <div class="mt-1">
                                        <span class="text-lg font-bold text-slate-900">{{
                                            formatTime(systemStatus.lastCheck) }}</span>
                                    </div>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-lg">
                                    üïí</div>
                            </div>
                        </div>

                            <!-- RECENT ACTIVITY REMOVED AS REQUESTED -->
                        </div>
                    </div>

                    <!-- ADMIN: USERS -->
                    <div v-if="activeTab === 'admin-users' && auth.role === 'Admin'" class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">User Management</h2>
                            <button @click="openUserModal()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Add
                                User</button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3">Username</th>
                                        <th class="px-6 py-3">Role</th>
                                        <th class="px-6 py-3">System</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr v-for="u in users" :key="u.id" class="hover:bg-slate-50">
                                        <td class="px-6 py-3">{{ u.username }}</td>
                                        <td class="px-6 py-3">{{ u.role }}</td>
                                        <td class="px-6 py-3">{{ u.isSystem ? 'YES' : '-' }}</td>
                                        <td class="px-6 py-3 text-right space-x-2">
                                            <button @click="openUserModal(u)"
                                                class="text-blue-600 font-bold">Edit</button>
                                            <button v-if="!u.isSystem" @click="deleteUser(u.id)"
                                                class="text-red-600 font-bold">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                                <!-- End Users -->
                            </table>
                        </div>
                    </div>

                    <!-- RAW DATA (for debugging ledger exact values) -->
                    <div v-if="activeTab === 's-rawdata'" class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">Raw Database Ledger</h2>
                            <button @click="loadRawData"
                                class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-300">Refresh</button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-auto max-h-[70vh]">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Balance</th>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Category</th>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider max-w-xs break-all">Description</th>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Acct ID</th>
                                        <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">AI?</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr v-for="tx in rawTransactions" :key="tx.id" class="hover:bg-slate-50">
                                        <td class="px-4 py-3 text-[10px] text-slate-500">{{ tx.transactionDate }}</td>
                                        <td class="px-4 py-3 font-mono font-bold" :class="tx.amount < 0 ? 'text-red-600' : 'text-green-600'">{{ tx.amount }}</td>
                                        <td class="px-4 py-3 font-mono text-slate-500">{{ tx.balance }}</td>
                                        <td class="px-4 py-3 text-xs">{{ tx.category }}</td>
                                        <td class="px-4 py-3 text-slate-900 truncate max-w-xs">{{ tx.description }}</td>
                                        <td class="px-4 py-3 text-[10px]">{{ tx.accountId }}</td>
                                        <td class="px-4 py-3 text-xs">{{ tx.isAiProcessed ? '‚úÖ' : '‚ùå' }}</td>
                                    </tr>
                                    <tr v-if="!rawTransactions || rawTransactions.length === 0">
                                        <td colspan="7" class="px-4 py-8 text-center text-slate-500">No raw data to display. Pull data from Investec first.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SETTINGS PAGES -->
                    <div v-if="activeTab.startsWith('s-')" class="max-w-3xl space-y-6 pb-20">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">Configuration</h2>
                            <button @click="saveSettings"
                                class="bg-brand-600 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-brand-700">Save
                                Changes</button>
                        </div>

                        <!-- IDENTITY -->
                        <div v-if="activeTab === 's-identity'"
                            class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                            <div>
                                <label class="text-xs font-bold text-slate-700">Display Name</label>
                                <input v-model="settings.userName" type="text"
                                    class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700">Currency / Locale</label>
                                <select v-model="settings.currencyCulture"
                                    class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm outline-none">
                                    <option value="en-ZA">South Africa (ZAR)</option>
                                    <option value="en-US">United States (USD)</option>
                                    <option value="en-GB">United Kingdom (GBP)</option>
                                </select>
                            </div>
                        </div>

                        <!-- MATH / ACTUARIAL -->
                        <div v-if="activeTab === 's-math'" class="space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                                <h3 class="font-bold text-slate-800 text-sm border-b pb-2 mb-4">Core Parameters</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">Analysis Window (Days)
                                            <help-tooltip
                                                text="How far back to look when calculating your average daily spend."></help-tooltip></label>
                                        <input v-model.number="settings.analysisWindowDays" type="number"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">EMA Alpha ({{
                                            settings.actuarialAlpha }}) <help-tooltip
                                                text="Lower values make the average react slower to recent spending spikes (more stable)."></help-tooltip></label>
                                        <input type="range" v-model.number="settings.actuarialAlpha" min="0.01"
                                            max="0.5" step="0.01"
                                            class="w-full mt-2 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">Unexpected Alert (R)
                                            <help-tooltip
                                                text="Alert via Telegram if a single transaction exceeds this amount unexpectedly."></help-tooltip></label>
                                        <input v-model.number="settings.unexpectedPaymentThreshold" type="number"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">Income Alert (R) <help-tooltip
                                                text="Alert via Telegram if a single credit/deposit exceeds this amount."></help-tooltip></label>
                                        <input v-model.number="settings.incomeAlertThreshold" type="number"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                                <div class="flex justify-between items-center border-b pb-2 mb-4">
                                    <h3 class="font-bold text-slate-800 text-sm">Classification</h3>
                                    <button @click="categorizeHistory" :disabled="categorizing"
                                        class="text-[10px] font-bold px-3 py-1 bg-brand-50 text-brand-700 rounded-full border border-brand-100 hover:bg-brand-100 transition-all disabled:opacity-50">
                                        {{ categorizing ? 'üè∑Ô∏è CATEGORIZING...' : 'üè∑Ô∏è CATEGORIZE HISTORY' }}
                                    </button>
                                </div>
                                <div v-if="categorizeResult"
                                    class="text-[10px] font-bold text-green-600 bg-green-50 p-2 rounded-lg border border-green-100">
                                    {{ categorizeResult }}
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">Fixed Cost Keywords <help-tooltip
                                            text="Comma-separated words. Transactions with these words are treated as bills, not variable spending."></help-tooltip></label>
                                    <textarea v-model="settings.fixedCostKeywords" rows="2"
                                        class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">Salary Keywords <help-tooltip
                                            text="Words used to identify your paycheck for cycle detection (e.g., 'SALARY', 'PAYROLL')."></help-tooltip></label>
                                    <textarea v-model="settings.salaryKeywords" rows="2"
                                        class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono"></textarea>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                                <h3 class="font-bold text-slate-800 text-sm border-b pb-2 mb-4">Advanced Actuarial</h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label class="text-xs font-bold text-slate-700">Min Cycle <help-tooltip
                                                text="Minimum allowed days between paychecks."></help-tooltip></label><input
                                            v-model.number="settings.minCycleDays" type="number"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Default Cycle <help-tooltip
                                                text="Fallback cycle length if no salary is detected."></help-tooltip></label><input
                                            v-model.number="settings.defaultCycleDays" type="number"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Max Cycle <help-tooltip
                                                text="Maximum allowed days between paychecks before clamping."></help-tooltip></label><input
                                            v-model.number="settings.maxCycleDays" type="number"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-xs font-bold text-slate-700">Pulse Baseline ({{
                                            settings.pulseBaselineThreshold }}) <help-tooltip
                                                text="Sensitivity for detecting spending drops (Month-to-Date vs Full Month)."></help-tooltip></label><input
                                            v-model.number="settings.pulseBaselineThreshold" type="number" step="0.01"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Hybrid Baseline ({{
                                            settings.hybridBaselineThreshold }}) <help-tooltip
                                                text="Sensitivity for category-specific spending drops."></help-tooltip></label><input
                                            v-model.number="settings.hybridBaselineThreshold" type="number" step="0.01"
                                            class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">VaR Confidence ({{
                                        settings.varConfidenceInterval }}) <help-tooltip
                                            text="Standard deviations for Value at Risk. 1.645 = 95% confidence."></help-tooltip></label>
                                    <input v-model.number="settings.varConfidenceInterval" type="number" step="0.001"
                                        class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">Degrees of Freedom (ŒΩ: {{
                                        settings.actuarialDegreesOfFreedom }}) <help-tooltip
                                            text="Lower values (e.g. 3) increase 'fat-tail' sensitivity (Black Swan modeling). Higher values approach Normal distribution."></help-tooltip></label>
                                    <input v-model.number="settings.actuarialDegreesOfFreedom" type="number" step="0.1"
                                        class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- CONNECTIONS -->
                        <div v-if="activeTab === 's-connections'" class="space-y-6">
                            <!-- Investec -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div
                                    class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-800 text-sm">Investec API</h3>
                                    <button @click="testInvestec"
                                        class="text-[10px] font-bold text-brand-600 hover:underline">TEST CONN</button>
                                </div>
                                <div class="p-6 space-y-4">
                                    <div><label class="text-xs font-bold text-slate-700">Client ID</label><input
                                            v-model="settings.investecClientId" type="text"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Secret</label><input
                                            v-model="settings.investecSecret" type="password"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">API Key</label><input
                                            v-model="settings.investecApiKey" type="password"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-slate-700">History
                                                (Days)</label><input v-model.number="settings.historyDaysBack"
                                                type="number"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        </div>
                                        <div><label class="text-xs font-bold text-slate-700">Sync Buffer</label><input
                                                v-model.number="settings.syncBufferDays" type="number" step="0.01"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Telegram -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div
                                    class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-800 text-sm">Telegram Bot</h3>
                                    <div class="flex gap-2">
                                        <button @click="registerWebhook"
                                            class="text-[10px] font-bold text-indigo-600 hover:underline">SET
                                            WEBHOOK</button>
                                        <button @click="testTelegram"
                                            class="text-[10px] font-bold text-brand-600 hover:underline">TEST
                                            MSG</button>
                                    </div>
                                </div>
                                <div class="p-6 space-y-4">
                                    <div><label class="text-xs font-bold text-slate-700">Bot Token</label><input
                                            v-model="settings.telegramBotToken" type="password"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Chat ID</label><input
                                            v-model="settings.telegramChatId" type="text"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Allowed IDs (Comma
                                            sep)</label><textarea v-model="settings.telegramAuthorizedChatIds" rows="2"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono"></textarea>
                                    </div>
                                </div>
                            </div>
                            <!-- Twilio -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between">
                                    <h3 class="font-bold text-slate-800 text-sm">WhatsApp (Twilio)</h3><button
                                        @click="testWhatsApp"
                                        class="text-[10px] font-bold text-brand-600 hover:underline">TEST MSG</button>
                                </div>
                                <div class="p-6 space-y-4">
                                    <div><label class="text-xs font-bold text-slate-700">Account SID</label><input
                                            v-model="settings.twilioAccountSid" type="text"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-700">Auth Token</label><input
                                            v-model="settings.twilioAuthToken" type="password"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-slate-700">Twilio Num</label><input
                                                v-model="settings.twilioWhatsAppNumber" type="text"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                        </div>
                                        <div><label class="text-xs font-bold text-slate-700">Your Num</label><input
                                                v-model="settings.authorizedWhatsAppNumber" type="text"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI -->
                        <div v-if="activeTab === 's-ai'" class="space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                                <h3 class="font-bold text-slate-800 text-sm border-b pb-2 mb-4">Primary Brain</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-xs font-bold text-slate-700">Provider</label><select
                                            v-model="settings.aiProvider" @change="loadModels(false)"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                            <option value="Ollama">Ollama</option>
                                            <option value="Gemini">Gemini</option>
                                        </select></div>
                                    <div><label class="text-xs font-bold text-slate-700">Persona Name</label><input
                                            v-model="settings.systemPersona" type="text"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">{{ settings.aiProvider === 'Ollama'
                                        ? 'Ollama URL' : 'Gemini Key' }}</label>
                                    <div class="flex gap-2 mt-1">
                                        <input v-if="settings.aiProvider === 'Ollama'" v-model="settings.ollamaBaseUrl"
                                            type="text"
                                            class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                        <input v-else v-model="settings.geminiApiKey" type="password"
                                            class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                        <button @click="testAi"
                                            class="px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold">Test</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">Model</label>
                                    <select v-if="settings.aiProvider === 'Ollama'" v-model="settings.ollamaModelName"
                                        class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        <option v-if="availableModels.length === 0" :value="settings.ollamaModelName">{{
                                            settings.ollamaModelName }}</option>
                                        <option v-for="m in availableModels" :key="m" :value="m">{{ m }}</option>
                                    </select>
                                    <select v-else v-model="settings.geminiModelName"
                                        class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        <option v-if="availableModels.length === 0" :value="settings.geminiModelName">{{
                                            settings.geminiModelName }}</option>
                                        <option v-for="m in availableModels" :key="m" :value="m">{{ m }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- RELIABILITY & FALLBACK -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                                <div class="flex justify-between items-center border-b pb-2 mb-4">
                                    <h3 class="font-bold text-slate-800 text-sm">Reliability & Fallback</h3>
                                    <div class="flex items-center gap-2">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Enable
                                            Fallback</label>
                                        <input type="checkbox" v-model="settings.enableAiFallback"
                                            class="w-4 h-4 text-brand-600 rounded">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">Retry Attempts</label>
                                        <input v-model.number="settings.aiRetryAttempts" type="number"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">Timeout (Seconds)</label>
                                        <input v-model.number="settings.aiTimeoutSeconds" type="number"
                                            class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                    </div>
                                </div>

                                <div v-if="settings.enableAiFallback" class="space-y-4 pt-4 border-t border-slate-100">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-xs font-bold text-slate-700">Fallback Provider</label>
                                            <select v-model="settings.fallbackAiProvider" @change="loadModels(true)"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                <option value="Ollama">Ollama</option>
                                                <option value="Gemini">Gemini</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-700">Fallback Model</label>
                                            <select v-if="settings.fallbackAiProvider === 'Ollama'"
                                                v-model="settings.fallbackOllamaModelName"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                <option v-if="availableFallbackModels.length === 0"
                                                    :value="settings.fallbackOllamaModelName">{{
                                                    settings.fallbackOllamaModelName }}</option>
                                                <option v-for="m in availableFallbackModels" :key="m" :value="m">{{ m }}
                                                </option>
                                            </select>
                                            <select v-else v-model="settings.fallbackGeminiModelName"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                <option v-if="availableFallbackModels.length === 0"
                                                    :value="settings.fallbackGeminiModelName">{{
                                                    settings.fallbackGeminiModelName }}</option>
                                                <option v-for="m in availableFallbackModels" :key="m" :value="m">{{ m }}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">{{ settings.fallbackAiProvider
                                            === 'Ollama' ? 'Fallback Ollama URL' : 'Fallback Gemini Key' }}</label>
                                        <div class="flex gap-2 mt-1">
                                            <input v-if="settings.fallbackAiProvider === 'Ollama'"
                                                v-model="settings.fallbackOllamaBaseUrl" type="text"
                                                class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                            <input v-else v-model="settings.fallbackGeminiApiKey" type="password"
                                                class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                            <button @click="testFallbackAi"
                                                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-xs font-bold border border-slate-200">Test
                                                Fallback</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- THINKING MODEL -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                                <div class="flex justify-between items-center border-b pb-2 mb-4">
                                    <h3 class="font-bold text-slate-800 text-sm">Thinking Model (Advanced)</h3>
                                    <div class="flex items-center gap-2">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Enable
                                            Thinking</label>
                                        <input type="checkbox" v-model="settings.enableThinkingModel"
                                            class="w-4 h-4 text-brand-600 rounded">
                                    </div>
                                </div>
                                <p class="text-[10px] text-slate-500 italic -mt-4 mb-4">When enabled, Gordon uses this
                                    model to "think" and reason before answering. If set to the same as Primary, it is
                                    ignored.</p>

                                <div v-if="settings.enableThinkingModel" class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-xs font-bold text-slate-700">Thinking Provider</label>
                                            <select v-model="settings.thinkingAiProvider"
                                                @change="loadModels(false, true)"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                <option value="Ollama">Ollama</option>
                                                <option value="Gemini">Gemini</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-700">Thinking Model</label>
                                            <select v-if="settings.thinkingAiProvider === 'Ollama'"
                                                v-model="settings.thinkingOllamaModelName"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                <option v-if="availableThinkingModels.length === 0"
                                                    :value="settings.thinkingOllamaModelName">{{
                                                    settings.thinkingOllamaModelName }}</option>
                                                <option v-for="m in availableThinkingModels" :key="m" :value="m">{{ m }}
                                                </option>
                                            </select>
                                            <select v-else v-model="settings.thinkingGeminiModelName"
                                                class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                <option v-if="availableThinkingModels.length === 0"
                                                    :value="settings.thinkingGeminiModelName">{{
                                                    settings.thinkingGeminiModelName }}</option>
                                                <option v-for="m in availableThinkingModels" :key="m" :value="m">{{ m }}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-700">{{ settings.thinkingAiProvider
                                            === 'Ollama' ? 'Thinking Ollama URL' : 'Thinking Gemini Key' }}</label>
                                        <div class="flex gap-2 mt-1">
                                            <input v-if="settings.thinkingAiProvider === 'Ollama'"
                                                v-model="settings.thinkingOllamaBaseUrl" type="text"
                                                class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                            <input v-else v-model="settings.thinkingGeminiApiKey" type="password"
                                                class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono">
                                            <button @click="testThinkingAi"
                                                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-xs font-bold border border-slate-200">Test
                                                Thinking</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EMAIL -->
                        <div v-if="activeTab === 's-delivery'"
                            class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-4">
                            <div class="flex justify-between">
                                <h3 class="font-bold text-slate-800 text-sm">SMTP Settings</h3><button
                                    @click="testEmail" class="text-[10px] font-bold text-brand-600 hover:underline">TEST
                                    EMAIL</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-700">Host</label><input
                                        v-model="settings.smtpHost" type="text"
                                        class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div><label class="text-xs font-bold text-slate-700">Port</label><input
                                        v-model.number="settings.smtpPort" type="number"
                                        class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                            <div><label class="text-xs font-bold text-slate-700">User</label><input
                                    v-model="settings.smtpUser" type="text"
                                    class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div><label class="text-xs font-bold text-slate-700">Password</label><input
                                    v-model="settings.smtpPass" type="password"
                                    class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div><label class="text-xs font-bold text-slate-700">To Address</label><input
                                    v-model="settings.emailTo" type="text"
                                    class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-4 border-t pt-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-700">Schedule Day</label>
                                    <select v-model="settings.reportDayOfWeek"
                                        class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        <option v-for="d in days" :key="d" :value="d">{{ d }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-700">Schedule Hour (24h)</label>
                                    <select v-model.number="settings.reportHour"
                                        class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                        <option v-for="h in 24" :key="h-1" :value="h-1">{{ (h-1).toString().padStart(2,
                                            '0') }}:00</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LOG TAB -->
                    <div v-if="activeTab === 'logs'" class="h-full flex flex-col space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center justify-between shrink-0 gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900 leading-tight">System Logs</h2>
                                <p class="text-xs text-slate-500 font-medium">Live backend activity (Auto-refresh: 3s)
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <input v-model="logSearch" type="text" placeholder="Search logs..."
                                        class="pl-8 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 w-48 shadow-sm transition-all">
                                    <span class="absolute left-2.5 top-2.5 text-slate-400 text-xs text-[10px]">üîç</span>
                                </div>
                                <select v-model="logFilter"
                                    class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-xs outline-none font-bold text-slate-700 shadow-sm focus:border-brand-500 transition-all">
                                    <option value="ALL">All Levels</option>
                                    <option value="INFORMATION">Info</option>
                                    <option value="WARNING">Warnings</option>
                                    <option value="ERROR">Errors</option>
                                </select>
                                <button @click="fetchLogs"
                                    class="p-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-all shadow-sm active:scale-95">üîÑ</button>
                            </div>
                        </div>

                        <!-- SAVED LOG FILE BROWSER -->
                        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden shrink-0">
                            <div
                                class="px-5 py-3 border-b border-slate-100 bg-slate-50/60 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm">üìÅ</span>
                                    <h3 class="font-bold text-slate-700 text-sm">Saved Log Files</h3>
                                    <span class="text-[10px] text-slate-400">(rolling daily, persisted to disk)</span>
                                </div>
                                <button @click="loadLogFiles"
                                    class="text-[10px] font-bold text-brand-600 hover:underline">REFRESH</button>
                            </div>
                            <div class="p-4">
                                <div class="flex flex-wrap items-center gap-3">
                                    <div>
                                        <label
                                            class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Level</label>
                                        <select v-model="logFileLevel"
                                            class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold text-slate-700">
                                            <option value="info">Info (INFO+)</option>
                                            <option value="error">Error (ERROR only)</option>
                                            <option value="debug">Debug (ALL)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label
                                            class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Date</label>
                                        <select v-model="logFileDate"
                                            class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-700 min-w-[130px]">
                                            <option value="">‚Äî select date ‚Äî</option>
                                            <option v-for="d in (logFileDates[logFileLevel] || [])" :key="d" :value="d">
                                                {{ d }}</option>
                                        </select>
                                    </div>
                                    <div class="mt-5">
                                        <button @click="loadLogFileContent" :disabled="!logFileDate || logFileLoading"
                                            class="px-4 py-2 bg-brand-600 text-white rounded-lg text-xs font-bold disabled:opacity-40 hover:bg-brand-700 transition-all">
                                            {{ logFileLoading ? '‚è≥ Loading...' : 'üìÑ Load' }}
                                        </button>
                                    </div>
                                    <div v-if="logFileContent" class="mt-5">
                                        <a :href="'/api/logs/files/' + logFileLevel + '/' + logFileDate"
                                            :download="'gordon-' + logFileLevel + '-' + logFileDate + '.log'"
                                            class="px-4 py-2 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-200 transition-all">
                                            ‚¨á Download
                                        </a>
                                    </div>
                                </div>
                                <div v-if="logFileContent"
                                    class="mt-4 bg-slate-900 rounded-xl p-4 overflow-auto max-h-64">
                                    <pre
                                        class="text-[10px] text-slate-300 font-mono leading-relaxed whitespace-pre-wrap">{{ logFileContent }}</pre>
                                </div>
                                <div v-else-if="!logFileDates.info?.length && !logFileLoading"
                                    class="mt-3 text-[10px] text-slate-400 italic">
                                    No saved log files yet ‚Äî they are created automatically as the app runs.
                                </div>
                            </div>
                        </div>


                        <!-- LIVE LOG STREAM -->
                        <div
                            class="flex-1 bg-slate-900 rounded-3xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col">
                            <div
                                class="flex-1 overflow-y-auto p-4 font-mono text-[11px] leading-relaxed divide-y divide-slate-800">
                                <div v-for="(log, idx) in filteredLogs" :key="idx"
                                    class="py-3 flex items-start gap-4 hover:bg-white/5 transition-colors group">
                                    <span class="text-slate-500 shrink-0 select-none tabular-nums">{{
                                        formatTime(log.timestamp) }}</span>
                                    <span :class="getLogLevelClass(log.level)"
                                        class="px-2 py-0.5 rounded text-[9px] font-bold uppercase shrink-0 min-w-[80px] text-center shadow-sm">
                                        {{ log.level }}
                                    </span>
                                    <div class="flex-1 min-w-0">
                                        <span class="text-indigo-400 font-bold block md:inline mb-1 md:mb-0 md:mr-2">[{{
                                            log.category.split('.').pop() }}]</span>
                                        <span class="text-slate-300 break-words whitespace-pre-wrap">{{ log.message
                                            }}</span>
                                    </div>
                                </div>
                                <div v-if="filteredLogs.length === 0"
                                    class="flex flex-col items-center justify-center h-full text-slate-500 py-20 opacity-50">
                                    <span class="text-5xl mb-4">üßä</span>
                                    <p class="font-bold">No logs found matching criteria.</p>
                                </div>
                            </div>
                            <div
                                class="px-6 py-3 bg-slate-800 text-slate-400 text-[10px] flex justify-between border-t border-slate-700 items-center">
                                <span class="font-medium tracking-wide">Showing {{ filteredLogs.length }} / {{
                                    logs.length }} entries</span>
                                <span
                                    class="text-brand-400 animate-pulse font-bold flex items-center gap-1.5 uppercase tracking-widest">
                                    <span class="w-1.5 h-1.5 bg-brand-500 rounded-full"></span> LIVE STREAMING</span>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- MOBILE BOTTOM NAVBAR -->
            <div
                class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-4 py-2 z-50 flex items-center justify-between shadow-lg">
                <button v-for="item in menuItems.slice(0, 4)" :key="item.id" @click="activeTab = item.id"
                    v-show="!item.adminOnly || auth.role === 'Admin'"
                    class="flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition-all"
                    :class="activeTab === item.id ? 'text-brand-600 bg-brand-50' : 'text-slate-400'">
                    <span class="text-xl">{{ item.icon }}</span>
                    <span class="text-[9px] font-bold uppercase tracking-tight">{{ item.name }}</span>
                </button>
                <button @click="activeTab = 's-ai'"
                    class="flex flex-col items-center gap-1 p-2 flex-1 rounded-xl transition-all"
                    :class="activeTab.startsWith('s-') ? 'text-brand-600 bg-brand-50' : 'text-slate-400'">
                    <span class="text-xl">‚öôÔ∏è</span>
                    <span class="text-[9px] font-bold uppercase tracking-tight">Setup</span>
                </button>
            </div>
        </template>

        <!-- TOAST NOTIFICATION -->
        <div v-if="toast.show"
            class="fixed top-4 right-4 z-[200] bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-pulse">
            <span class="text-xl">üîî</span>
            <span class="font-bold text-sm">{{ toast.msg }}</span>
        </div>

        <!-- USER MODAL -->
        <div v-if="isUserModalOpen" class="fixed inset-0 z-[150] bg-black/50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 space-y-4">
                <h3 class="text-lg font-bold">{{ userForm.id ? 'Edit User' : 'New User' }}</h3>
                <input v-if="!userForm.id" v-model="userForm.username" type="text" placeholder="Username"
                    class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none">
                <input v-model="userForm.password" type="password"
                    :placeholder="userForm.id ? 'New Password (Optional)' : 'Password'"
                    class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none">
                <select v-model="userForm.role"
                    class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none">
                    <option value="User">User</option>
                    <option value="Admin">Admin</option>
                </select>
                <div class="flex gap-2 justify-end pt-2">
                    <button @click="isUserModalOpen = false" class="px-4 py-2 text-slate-500 font-bold">Cancel</button>
                    <button @click="saveUser"
                        class="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold">Save</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        const HelpTooltip = {
            props: ['text'],
            template: `
                <div class="relative inline-flex items-center ml-1 group">
                    <span class="cursor-help text-slate-400 hover:text-brand-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </span>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg z-50 pointer-events-none text-center leading-tight opacity-0 group-hover:opacity-100 transition-opacity">
                        {{ text }}
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
                    </div>
                </div>
            `
        };

        createApp({
            components: { HelpTooltip },
            data() {
                return {
                    loading: false,
                    sendingReport: false,
                    categorizing: false,
                    categorizeResult: "",
                    authView: 'login',
                    auth: { token: localStorage.getItem('token'), username: localStorage.getItem('username'), role: localStorage.getItem('role') || 'User' },
                    loginForm: { username: '', password: '' },
                    registerForm: { username: '', password: '' },
                    activeTab: 'dashboard',
                    users: [],
                    userForm: { id: 0, username: '', password: '', role: 'User' },
                    isUserModalOpen: false,
                    menuItems: [
                        { id: 'dashboard', name: 'Dashboard', icon: 'üè†' },
                        { id: 's-identity', name: 'Identity', icon: 'üë§' },
                        { id: 's-connections', name: 'Connections', icon: 'üîó' },
                        { id: 's-ai', name: 'Brain', icon: 'üß†' },
                        { id: 's-math', name: 'Math & Logic', icon: 'üß™' },
                        { id: 's-delivery', name: 'Email & Schedule', icon: '‚úâÔ∏è' },
                        { id: 'logs', name: 'System Logs', icon: 'üìã' },
                        { id: 'admin-users', name: 'User Mgmt', icon: 'üõ°Ô∏è', adminOnly: true }
                    ],
                    settings: {
                        userName: 'User', currencyCulture: 'en-ZA', investecBaseUrl: 'https://openapi.investec.com/',
                        aiProvider: 'Ollama', ollamaBaseUrl: '', systemPersona: 'Gordon',
                        smtpPort: 587, reportDayOfWeek: 'Monday', reportHour: 9,
                        analysisWindowDays: 90, actuarialAlpha: 0.15, unexpectedPaymentThreshold: 3000, incomeAlertThreshold: 5000,
                        historyDaysBack: 180, syncBufferDays: 0.05,
                        minCycleDays: 20, maxCycleDays: 45, defaultCycleDays: 30,
                        pulseBaselineThreshold: 0.1, hybridBaselineThreshold: 0.1, varConfidenceInterval: 1.645,
                        enableAiFallback: true, fallbackAiProvider: 'Gemini', fallbackOllamaBaseUrl: 'http://host.docker.internal:11434',
                        fallbackOllamaModelName: 'llama3', fallbackGeminiApiKey: '', aiTimeoutSeconds: 90, aiRetryAttempts: 2,
                        enableThinkingModel: false, thinkingAiProvider: 'Ollama', thinkingOllamaBaseUrl: 'http://host.docker.internal:11434',
                        thinkingOllamaModelName: 'deepseek-r1', thinkingGeminiModelName: 'gemini-2.0-flash-thinking-exp', thinkingGeminiApiKey: ''
                    },
                    availableModels: [],
                    availableFallbackModels: [],
                    availableThinkingModels: [],
                    days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                    systemStatus: {
                        investecOnline: false,
                        databaseOnline: true,
                        aiPrimaryOnline: false,
                        aiFallbackOnline: false,
                        lastTelegramHit: null,
                        lastTelegramError: '',
                        lastCheck: null,
                        lastAiCheck: null,
                        lastInvestecCheck: null
                    },
                    healthStats: null,
                    toast: { show: false, msg: '' },
                    recentTransactions: [],
                    logs: [],
                    logFilter: 'ALL',
                    logSearch: '',
                    logPolling: null,
                    logFileLevel: 'info',
                    logFileDate: '',
                    logFileDates: {},
                    logFileContent: '',
                    logFileLoading: false
                }
            },
            computed: {
                filteredLogs() {
                    return this.logs.filter(l => {
                        const matchLevel = this.logFilter === 'ALL' || l.level.toUpperCase() === this.logFilter;
                        const matchSearch = !this.logSearch ||
                            l.message.toLowerCase().includes(this.logSearch.toLowerCase()) ||
                            l.category.toLowerCase().includes(this.logSearch.toLowerCase());
                        return matchLevel && matchSearch;
                    });
                }
            },
            watch: {
                activeTab(newTab) {
                    if (newTab === 'logs') {
                        this.fetchLogs();
                        this.startLogPolling();
                        this.loadLogFiles();
                    } else {
                        this.stopLogPolling();
                    }
                    if (newTab === 's-rawdata') {
                        this.loadRawData();
                    }
                    if (newTab === 'admin-users') {
                        this.loadUsers();
                    }
                }
            },
            mounted() {
                if (this.auth.token) {
                    this.loadData();
                    if (this.auth.role === 'Admin') this.loadUsers();
                    // Give it a moment to render the dashboard before loading charts
                    setTimeout(() => { this.loadCharts(); }, 1000);
                }
            },
            methods: {
                async api(path, method = 'GET', body = null) {
                    const headers = { 'Authorization': `Bearer ${this.auth.token}` };
                    if (body) headers['Content-Type'] = 'application/json';
                    const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : null });
                    if (res.status === 401) this.logout();
                    return res;
                },
                async login() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const payload = JSON.parse(atob(data.token.split('.')[1]));
                            const role = payload.role || 'User';

                            this.auth = { token: data.token, username: data.username, role: role };
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('username', data.username);
                            localStorage.setItem('role', role);

                            this.loadData();
                            if (role === 'Admin') this.loadUsers();
                        } else this.showToast("Login Failed");
                    } catch { this.showToast("Network Error"); }
                    finally { this.loading = false; }
                },
                async register() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/auth/register', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.registerForm)
                        });
                        if (res.ok) { this.showToast("Registered! Please login."); this.authView = 'login'; }
                        else this.showToast("Registration Failed");
                    } finally { this.loading = false; }
                },
                logout() {
                    this.auth = { token: null, username: null, role: null };
                    localStorage.clear();
                },
                async loadData() {
                    try {
                        const [settingsRes, dashboardRes] = await Promise.all([
                            this.api('/api/settings'),
                            this.api('/api/dashboard')
                        ]);

                        if (settingsRes.ok) {
                            this.settings = await settingsRes.json();
                            this.loadModels(false);
                            this.loadModels(true);
                            this.loadModels(false, true);
                            this.$nextTick(() => {
                                document.title = `Gordon | ${this.settings.userName || this.auth.username}`;
                            });
                        }

                        if (dashboardRes.ok) {
                            const dashboardData = await dashboardRes.json();
                            this.healthStats = dashboardData.healthStats || null;
                            this.systemStatus = dashboardData.systemStatus || {};

                            // Re-enable if needed in another view, but removed from UI main panel per prompt
                            this.recentTransactions = dashboardData.recentTransactions || [];

                            if (this.activeTab === 'dashboard') {
                                this.loadCharts();
                            }
                        }
                    } catch (e) {
                        if (e.message && e.message.includes("401")) this.logout();
                        console.error("Failed to load dashboard data.", e);
                    }
                },
                async loadRawData() {
                    try {
                        const res = await this.api('/api/transactions?limit=250');
                        if (res.ok) {
                            this.rawTransactions = await res.json();
                        } else {
                            console.error("Failed to load raw transactions", res.statusText);
                            this.rawTransactions = [];
                        }
                    } catch (e) {
                        console.error("Failed to load raw transactions", e);
                        this.rawTransactions = [];
                    }
                },
                async loadUsers() {
                    const res = await this.api('/api/users');
                    if (res.ok) this.users = await res.json();
                },
                async loadModels(useFallback = false, useThinking = false) {
                    const res = await this.api(`/api/settings/models?useFallback=${useFallback}&useThinking=${useThinking}`, 'POST', this.settings);
                    if (res.ok) {
                        if (useThinking) this.availableThinkingModels = await res.json();
                        else if (useFallback) this.availableFallbackModels = await res.json();
                        else this.availableModels = await res.json();
                    }
                }, openUserModal(u = null) {
                    this.userForm = u ? { ...u, password: '' } : { id: 0, username: '', password: '', role: 'User' };
                    this.isUserModalOpen = true;
                },
                async saveUser() {
                    const method = this.userForm.id ? 'PUT' : 'POST';
                    const url = this.userForm.id ? `/api/users/${this.userForm.id}` : '/api/users';
                    const res = await this.api(url, method, this.userForm);
                    if (res.ok) { this.showToast("User Saved"); this.isUserModalOpen = false; this.loadUsers(); }
                    else this.showToast("Save Failed");
                },
                async deleteUser(id) {
                    if (!confirm("Are you sure?")) return;
                    const res = await this.api(`/api/users/${id}`, 'DELETE');
                    if (res.ok) { this.showToast("User Deleted"); this.loadUsers(); }
                },
                async saveSettings() {
                    const res = await this.api('/api/settings', 'PUT', this.settings);
                    if (res.ok) this.showToast("Settings Saved");
                },
                async testInvestec() {
                    await this.saveSettings();
                    const res = await this.api('/api/settings/test-investec', 'POST');
                    if (res.ok) { this.showToast("Investec Connected"); this.loadData(); } else this.showToast("Failed");
                },
                async testEmail() {
                    await this.saveSettings();
                    const res = await this.api('/api/settings/test-email', 'POST');
                    if (res.ok) this.showToast("Email Sent"); else this.showToast("Failed");
                },
                async testAi() {
                    const res = await this.api('/api/settings/test-ai', 'POST', this.settings);
                    if (res.ok) this.showToast("Primary AI Online"); else this.showToast("Test Failed");
                },
                async categorizeHistory() {
                    if (this.categorizing) return;
                    this.categorizing = true;
                    this.categorizeResult = "";
                    try {
                        const res = await this.api('/api/transactions/categorize-all', 'POST');
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || "Categorization failed");
                        this.categorizeResult = data.message;
                        this.showToast("History Categorized");
                        this.loadData();
                        this.loadCharts();
                    } catch (err) {
                        this.showToast(err.message);
                    } finally {
                        this.categorizing = false;
                    }
                },
                async loadCharts() {
                    try {
                        const resCat = await this.api('/api/chartdata/spending-by-category?days=30');
                        if (resCat.ok) {
                            const data = await resCat.json();
                            this.renderCategoryChart(data);
                        }

                        const resBal = await this.api('/api/chartdata/daily-balance?days=30');
                        if (resBal.ok) {
                            const data = await resBal.json();
                            this.renderBalanceChart(data);
                        }
                    } catch (err) {
                        console.error("Failed to load charts", err);
                    }
                },
                renderCategoryChart(data) {
                    const ctx = document.getElementById('categoryChart')?.getContext('2d');
                    if (!ctx) return;
                    if (this.categoryChart) this.categoryChart.destroy();
                    this.categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.map(d => d.label),
                            datasets: [{
                                data: data.map(d => d.value),
                                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
                    });
                },
                renderBalanceChart(data) {
                    const ctx = document.getElementById('balanceChart')?.getContext('2d');
                    if (!ctx) return;
                    if (this.balanceChart) this.balanceChart.destroy();
                    this.balanceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => new Date(d.date).toLocaleDateString()),
                            datasets: [{
                                label: 'Balance',
                                data: data.map(d => d.balance),
                                borderColor: '#6366f1',
                                fill: true,
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: false, ticks: { font: { size: 10 } } },
                                x: { ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 45 } }
                            }
                        }
                    });
                },
                async saveSettings() {
                    const res = await this.api('/api/settings', 'PUT', this.settings);
                    if (res.ok) this.showToast("Settings Saved");
                },
                async testFallbackAi() {
                    await this.saveSettings();
                    const res = await this.api('/api/settings/test-fallback-ai', 'POST');
                    if (res.ok) { this.showToast("Fallback AI Connected"); this.loadData(); } else this.showToast("Fallback Failed");
                },
                async testThinkingAi() {
                    await this.saveSettings();
                    const res = await this.api('/api/settings/test-thinking-ai', 'POST');
                    if (res.ok) {
                        this.showToast("Thinking AI Connected");
                        this.loadData();
                    } else this.showToast("Thinking Failed");
                },
                async testTelegram() {
                    await this.saveSettings();
                    const res = await this.api('/api/settings/test-telegram', 'POST');
                    if (res.ok) this.showToast("Telegram Sent"); else this.showToast("Failed");
                },
                async testWhatsApp() {
                    await this.saveSettings();
                    const res = await this.api('/api/settings/test-whatsapp', 'POST');
                    if (res.ok) this.showToast("WhatsApp Sent"); else this.showToast("Failed");
                },
                async registerWebhook() {
                    let baseUrl = prompt("Enter your public HTTPS URL (e.g., https://yourdomain.com):", "https://financeai.wethegordons.co.za");
                    if (!baseUrl) return;
                    baseUrl = baseUrl.replace(/\/$/, "").replace(/\/telegram\/webhook$/, "");
                    const fullUrl = baseUrl + '/telegram/webhook';
                    try {
                        const res = await this.api('/telegram/setup-webhook', 'POST', { Url: fullUrl });
                        if (res.ok) this.showToast("Webhook Registered!");
                        else this.showToast("Failed");
                    } catch { this.showToast("Network Error"); }
                },
                async forceRepull() {
                    if (!confirm("Resync all transactions?")) return;
                    const res = await this.api('/api/settings/force-repull', 'POST');
                    if (res.ok) this.showToast("Sync Started");
                },
                async categorizeExisting() {
                    this.categorizing = true;
                    try {
                        const res = await this.api('/api/settings/categorize-existing', 'POST');
                        if (res.ok) {
                            const msg = await res.text();
                            this.showToast(msg);
                            this.loadData();
                        } else this.showToast("Failed to categorize");
                    } finally {
                        this.categorizing = false;
                    }
                },
                async sendReportNow() {
                    this.sendingReport = true;
                    try {
                        const res = await this.api('/api/settings/send-report-now', 'POST');
                        if (res.ok) this.showToast("Report Sent"); else this.showToast("Failed");
                    } finally { this.sendingReport = false; }
                },
                async fetchLogs() {
                    const res = await this.api('/api/logs');
                    if (res.ok) this.logs = await res.json();
                },
                async loadLogFiles() {
                    const res = await this.api('/api/logs/files');
                    if (res.ok) this.logFileDates = await res.json();
                },
                async loadLogFileContent() {
                    if (!this.logFileDate) return;
                    this.logFileLoading = true;
                    this.logFileContent = '';
                    try {
                        const res = await this.api(`/api/logs/files/${this.logFileLevel}/${this.logFileDate}/tail?lines=200`);
                        if (res.ok) this.logFileContent = await res.text();
                        else this.showToast('Log file not found');
                    } finally {
                        this.logFileLoading = false;
                    }
                },
                startLogPolling() {
                    this.stopLogPolling();
                    this.logPolling = setInterval(() => this.fetchLogs(), 3000);
                },
                stopLogPolling() {
                    if (this.logPolling) {
                        clearInterval(this.logPolling);
                        this.logPolling = null;
                    }
                },
                getLogLevelClass(level) {
                    level = level.toUpperCase();
                    if (level === 'ERROR' || level === 'CRITICAL') return 'text-red-600 bg-red-50';
                    if (level === 'WARNING') return 'text-amber-600 bg-amber-50';
                    if (level === 'INFORMATION') return 'text-blue-600 bg-blue-50';
                    return 'text-slate-500 bg-slate-50';
                },
                showToast(msg) {
                    this.toast = { show: true, msg };
                    setTimeout(() => this.toast.show = false, 3000);
                },
                formatTime(d) { return d ? new Date(d).toLocaleTimeString() : 'Never'; },
                formatDate(d) { return d ? new Date(d).toLocaleDateString(undefined, { day: 'numeric', month: 'short' }) : ''; },
                formatCurrency(v) { return new Intl.NumberFormat(this.settings.currencyCulture || 'en-ZA', { style: 'currency', currency: 'ZAR' }).format(v); }
            }
        }).mount('#app');
    </script>
</body>

</html>